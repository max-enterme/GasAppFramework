name: GAS Deploy and Test

# GASã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
# å¿…è¦ãªSecrets: CLASPRC_JSON, GAS_CONFIG_JSON
on:
  workflow_dispatch:
    inputs:
      deploy:
        description: 'clasp push ã‚’å®Ÿè¡Œã™ã‚‹'
        required: false
        default: true
        type: boolean
      test:
        description: 'GASãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹'
        required: false
        default: true
        type: boolean

jobs:
  gas-deploy-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup clasp authentication
        if: inputs.deploy == true
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          if [ -z "$CLASPRC_JSON" ]; then
            echo "âš ï¸ CLASPRC_JSON ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
            exit 0
          fi
          mkdir -p ~/.config
          echo "$CLASPRC_JSON" > ~/.clasprc.json
          echo "âœ… claspèªè¨¼æƒ…å ±ã‚’è¨­å®šã—ã¾ã—ãŸ"

      - name: Setup GAS config
        env:
          GAS_CONFIG_JSON: ${{ secrets.GAS_CONFIG_JSON }}
        run: |
          if [ -z "$GAS_CONFIG_JSON" ]; then
            echo "âš ï¸ GAS_CONFIG_JSON ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
            exit 0
          fi
          echo "$GAS_CONFIG_JSON" > .gas-config.json
          echo "âœ… GASè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"

      - name: Build project
        if: inputs.deploy == true
        run: npm run build

      - name: Deploy to GAS
        if: inputs.deploy == true && env.CLASPRC_JSON != ''
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          if [ -z "$CLASPRC_JSON" ]; then
            echo "âš ï¸ CLASPRCãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—"
            exit 0
          fi
          npm run gas:push

      - name: Run GAS tests
        if: inputs.test == true
        id: gas_test
        continue-on-error: true
        run: |
          npm run gas:test 2>&1 | tee gas-test-output.txt
          echo "gas_test_exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Display test results
        if: inputs.test == true
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š GASãƒ†ã‚¹ãƒˆçµæœ"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cat gas-test-output.txt
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Upload test results
        if: inputs.test == true
        uses: actions/upload-artifact@v4
        with:
          name: gas-test-results
          path: gas-test-output.txt

      - name: Fail if tests failed
        if: inputs.test == true && steps.gas_test.outputs.gas_test_exit_code != '0'
        run: |
          echo "âŒ GASãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
